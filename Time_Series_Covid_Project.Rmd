---
title: "Time Series Covid Project"
author: "Reagan Meagher and Megan Riley"

output: html_document
---

[site]: https://covidtracking.com/ "The Covid Tracking Project"

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Global Options
remove(list = ls())
options(scipen = 999)

#Load Packages
library(tidyverse)
library(dplyr)
library(tseries)
library(ggplot2)
library(forecast)
library(tswge)
library(tseries)
library(orcutt)
library(mice)
library(nnfor)
```

#*Modeling Covid19 Time Series* 


Covid19 is a worldwide pandemic that will likely define 2020. In the United States, currently over four million people have been infected and over 150,000 have died as a result of Covid19. As the pandemic continues, limiting infections, serious harm, and death is a primary concern for all involved. 

As this is a novel illness, we know relatively little, but understanding how Covid19 is spreading and judging the severity of an outbreak can be approximated with the data we have available. In this report we aim to build effective time series models to forecast future Covid19 cases using the techniques we have learned from this Time Series course. 
##*Goal One:  Data Collection *

The data source we are using is sourced from [The Covid Tracking Project][site]. 



```{r}
initial_data_fl <- read.csv(file="https://raw.githubusercontent.com/megnn/TimeSeries_Covid/master/covidtracking_FL_data.csv", header=TRUE)
initial_data_us <- read.csv(file="https://raw.githubusercontent.com/megnn/TimeSeries_Covid/master/covidtracking_US_data.csv", header=TRUE)

initial_data_fl = initial_data_fl[order(nrow(initial_data_fl):1),]
initial_data_us = initial_data_us[order(nrow(initial_data_us):1),]

len_fl = dim(initial_data_fl)[1]
len_us = dim(initial_data_us)[1]

```

Insert exploration of cases, deaths, hospitalizations etc. 

Plotting the daily positive cases in Florida and US. 

```{r}
plot(x = seq(1,len_fl), y = initial_data_fl$positiveIncrease, type = "l")
plot(x = seq(1,len_us), y = initial_data_us$positiveIncrease, type = "l")
```

##*Positive Percentage*

Positive Percentage is a statistic that calculates daily positive tests as a percentage of daily overall tests returned. We calculated this column and added it to our data below followed by some visual exploration of the statistic itself. 

Overall we see a clear instance of high and often 100% positive test rates early on in the first days and weeks of the pandemic spread. We understand this as a result of the fact that Covid19 spread fast and we had more community spread than anticipated early on without the testing available. It is abundantly clear that when we have extremely high percent positive rates near 100% we can expect true positive case numbers at the time to be under represented. But without better epidemlogical understanding we can't make judgement calls on true case numbers when percent positives rise from 5% to 10% as we see begin to happen somewhat in recent days in Florida. 


```{r}
for (i in 1:nrow(initial_data_fl)) {
  n <- round((initial_data_fl$positiveIncrease / initial_data_fl$totalTestResultsIncrease) * 100, digits = 4)
  initial_data_fl$positive_percentage <- n
}

for (i in 1:nrow(initial_data_us)) {
  n <- round((initial_data_us$positiveIncrease / initial_data_us$totalTestResultsIncrease) * 100, digits = 4)
  initial_data_us$positive_percentage <- n
}


#Percent Positive Exploration
plot(x = seq(1:len_fl), y = initial_data_fl$positive_percentage, type = "l")

plot(x = seq(21:135), y = initial_data_fl[21:135,42], type = "l")


plot(x = seq(1:len_us), y = initial_data_us$positive_percentage, type = "l")

plot(x = seq(45:177), y = initial_data_us[45:177,26], type = "l")


```



Positive Percentage as a metric is a measure of two main things, how many tests are we administering and how many positives are we receiving. If tests are skyrocketing while positive cases are increasing, we would see a stable or even diminishing line which could indicate not a pandemic under control but simply better testing resources but could be interpreted as a pandemic managed. 

Keeping tests increasing to continue to keep percent positives level is a good indication we have leveled up our resources to continue to diagnose the pandemic at the same level, but if we need to scale up our testing to keep the same positive percentage, there is more covid spread. 

However, an increasing positive percentage is a good indicator that our testing resources may not be up to actually up to tracking the current stage of the pandemic. 


```{r}
plot(x = seq(1:len_us), y = initial_data_us$totalTestResultsIncrease, type = "l")
plot(x = seq(1:len_fl), y = initial_data_fl$totalTestResultsIncrease, type = "l")

```

####Data Preperation

In order to model new case numbers by day we set up dataframes with only our date and positive increase amount per day.

```{r}
newcases_fl <- dplyr::select(initial_data_fl, c("date", "positiveIncrease"))
newcases_us <- dplyr::select(initial_data_us, c("date", "positiveIncrease"))
```



####Checking for NAs

We can see with the missing value analysis below that we have no NAs present in our new case data. 

```{r NA eval}
#Checking for NAs
md.pattern(newcases_fl)
# No NAs present


#Checking for NAs
md.pattern(newcases_us)
#No NAs present

```


(Does this really need to be in the univariate section? If so should we drop our lesser models? )
###**Florida Daily Cases:**

As we can see below, the daily new positive cases in Florida is in recent days spiking. We also have the ACFs and Spectral Density plots laid out. In the ACFs we see a clear pattern of slowly dampening frequencies, indicative of non stationarity. And within the spectral density plot we see a peak at zero which could indicate stationary wandering or an aperiodic trend. Given our data shows a strong upward trend in recent days, the evidence at hand strongly points to the new positive cases behaving in a non stationary way.  

```{r}

plotts.sample.wge(newcases_fl$positiveIncrease)

```



###Florida Cases - Baseline Model One

To model Florida cases we start with a base model. We can see that the most favored model by BIC is an AR(1). So we begin by building that model. Our AR(1) has a phi of .975, quite close to the unit circle, which we expect to model strongly wandering behavior. 

This model has an AIC estimate of 14.01. 

In order to estimate an average ASE, we are running this model over segments of our data with 54 iterations. In each case training with at least seventy data points and predicting on twelve. Overall this produces an average ASE of 6,353,070. 

Below our ASE estimates we forecast short term and long term forecasts and both follow AR(1) behavior of data dampening towards our mean. 

```{r}
aic5.wge(newcases_fl$positiveIncrease, type = 'bic')


fl_ar_1 = est.ar.wge(newcases_fl$positiveIncrease, p = 1)

fl_ar_1$aic

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(135-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_fl$positiveIncrease[i:(i+(trainingSize-1))],phi = fl_ar_1$phi, n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_fl$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(2,1,1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE


short_fl_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = fl_ar_1$phi, n.ahead = 7, plot = TRUE)

long_us_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = fl_ar_1$phi, n.ahead = 90, plot = TRUE)



```

###Florida Cases - Baseline Model Two

To model Florida cases we start with a base model. We can see that the most favored model by BIC is an AR(1). So we begin by building that model. Our AR(1) has a phi of .975, quite close to the unit circle, which we expect to model strongly wandering behavior. 

This model has an AIC estimate of 14.01. 

In order to estimate an average ASE, we are running this model over segments of our data with 54 iterations. In each case training with at least seventy data points and predicting on twelve. Overall this produces an average ASE of 6,353,070. 

Below our ASE estimates we forecast short term and long term forecasts and both follow AR(1) behavior of data dampening towards our mean. 


```{r}
aic5.wge(newcases_fl$positiveIncrease)
aic5.wge(newcases_fl$positiveIncrease, type = 'bic')


fl_arma_21 = est.arma.wge(newcases_fl$positiveIncrease, p = 2, q = 1)
fl_arma_21
fl_arma_21$aic

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(135-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_fl$positiveIncrease[i:(i+(trainingSize-1))],phi = fl_arma_21$phi, theta = fl_arma_21$theta, n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_fl$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(2,1,1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE


short_fl_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = fl_arma_21$phi,theta = fl_arma_21$theta, n.ahead = 7, plot = TRUE)

long_us_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = fl_arma_21$phi,theta = fl_arma_21$theta, n.ahead = 90, plot = TRUE)



```



###**US Daily Cases:**



```{r}
plotts.sample.wge(newcases_us$positiveIncrease)

plot(x = seq(1,len_us), y = newcases_us$positiveIncrease, type = "l", main = 'United States Covid-19 Daily Positive Cases', xlab = 'Time (Days From Start of Pandemic)', ylab = 'Positive Daily Cases')
 
```


###US Model One - AR 1 

```{r}
aic5.wge(newcases_us$positiveIncrease)
aic5.wge(newcases_us$positiveIncrease, type = 'bic')


us_ar_1 = est.ar.wge(newcases_us$positiveIncrease, p = 1)
us_ar_1
us_ar_1$aic

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(177-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_us$positiveIncrease[i:(i+(trainingSize-1))],phi = us_ar_1$phi, n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_us$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(2,1,1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE


short_fl_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = us_ar_1$phi, n.ahead = 7, plot = TRUE)

long_us_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = us_ar_1$phi, n.ahead = 90, plot = TRUE)



```


US PArt 2 - ARMA 1 2

```{r}
aic5.wge(newcases_fl$positiveIncrease)
aic5.wge(newcases_fl$positiveIncrease, type = 'bic')


us_arma_12 = est.arma.wge(newcases_us$positiveIncrease, p = 1, q = 2)
us_arma_12
us_arma_12$aic

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(177-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_us$positiveIncrease[i:(i+(trainingSize-1))],phi = us_arma_12$phi, theta = us_arma_12$theta, n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_us$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(2,1,1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE


short_fl_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = us_arma_12$phi,theta = us_arma_12$theta, n.ahead = 7, plot = TRUE)

long_us_ar1 = fore.aruma.wge(newcases_us$positiveIncrease,phi = us_arma_12$phi,theta = us_arma_12$theta, n.ahead = 90, plot = TRUE)



```


##*Goal Two: Univariate Analysis*

```{r}

```



##*Goal Three: Multivariate Analysis*

