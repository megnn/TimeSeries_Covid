---
title: "Time_Series_Covid_Project"
author: "Reagan Meagher and Megan Riley"

output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Global Options
remove(list = ls())
options(scipen = 999)

#Load Packages
library(tidyverse)
library(dplyr)
library(tseries)
library(ggplot2)
library(forecast)
library(tswge)
library(tseries)
library(orcutt)
library(mice)
```

```{r}
initial_data_fl <- read.csv(file="https://raw.githubusercontent.com/megnn/TimeSeries_Covid/master/covidtracking_FL_data.csv", header=TRUE)
initial_data_us <- read.csv(file="https://raw.githubusercontent.com/megnn/TimeSeries_Covid/master/covidtracking_US_data.csv", header=TRUE)

initial_data_fl = initial_data_fl[order(nrow(initial_data_fl):1),]
initial_data_us = initial_data_us[order(nrow(initial_data_us):1),]
```

```{r}
for (i in 1:nrow(initial_data_fl)) {
  n <- round((initial_data_fl$positiveIncrease / initial_data_fl$totalTestResultsIncrease) * 100, digits = 4)
  initial_data_fl$positive_percentage <- n
}

for (i in 1:nrow(initial_data_us)) {
  n <- round((initial_data_us$positiveIncrease / initial_data_us$totalTestResultsIncrease) * 100, digits = 4)
  initial_data_us$positive_percentage <- n
}

len_fl = dim(initial_data_fl)[1]
len_us = dim(initial_data_us)[1]
```

Another way to add the columns

```{r}

initial_data_fl = initial_data_fl %>% mutate(positive_percentage = round((initial_data_fl$positiveIncrease / initial_data_fl$totalTestResultsIncrease) * 100, digits = 4))

initial_data_us = initial_data_us %>% mutate(positive_percentage = round((initial_data_us$positiveIncrease / initial_data_us$totalTestResultsIncrease) * 100, digits = 4))

len_fl = dim(initial_data_fl)[1]
len_us = dim(initial_data_us)[1]

```

Looking at percent positives.

Also segmenting the percent positive trends after initial high positive rates. This allows us to model positive percentage if we make the assumption the pattern of positive percentages has changed after a first period of high percent positives.  

```{r}

plot(x = seq(1:len_fl), y = initial_data_fl$positive_percentage, type = "l")

plot(x = seq(21:135), y = initial_data_fl[21:135,42], type = "l")


plot(x = seq(1:len_us), y = initial_data_us$positive_percentage, type = "l")

plot(x = seq(45:177), y = initial_data_us[45:177,26], type = "l")


```

The case agains positive percentages. Positive Percentage as a metric is a measure of two main things, how many tests are we administering and how many positives are we receiving. If tests are skyrocketing while positives are increasing, we would see a stable line which could indicate not a pandemic under control but simply better testing resources. 

Keeping tests increasing to continue to keep percent positives level is a good indication we have leveled up our resources to continue to diagnose the pandemic at the same level, but if we need to scale up our testing to keep the same positive percentage, there is more covid spread. 

An increasing positive percentage is a good indicator that our testing resources may not be up to actually up to tracking the current stage of the pandemic. 


```{r}
plot(x = seq(1:len_us), y = initial_data_us$totalTestResultsIncrease, type = "l")
plot(x = seq(1:len_fl), y = initial_data_fl$totalTestResultsIncrease, type = "l")

```


Setting up data frames for predicting cases. 

```{r}
newcases_fl <- dplyr::select(initial_data_fl, c("date", "positiveIncrease"))
newcases_us <- dplyr::select(initial_data_us, c("date", "positiveIncrease"))
```

Plotting the daily positive cases in Florida and US. 

```{r}
plot(x = seq(1,len_fl), y = newcases_fl$positiveIncrease, type = "l")
plot(x = seq(1,len_us), y = newcases_us$positiveIncrease, type = "l")
```

Checking for NAs

```{r NA eval}
#Checking for NAs
md.pattern(newcases_fl)
# No NAs present

#Drop NAs that are present
newcases_fl <- na.omit(newcases_fl)

#Checking for NAs
md.pattern(newcases_us)
#No NAs present

#Drop NAs that are present
newcases_us <- na.omit(newcases_us)
```

```{r}
plotts.sample.wge(newcases_fl$positiveIncrease)
```



Building an ARIMA model on Florida Cases

```{r}
aic5.wge(newcases_fl$positiveIncrease)
aic5.wge(newcases_fl$positiveIncrease, type = 'bic')

positiveIncrease_diff = artrans.wge(newcases_fl$positiveIncrease, 1)
newcases_fl_diff = data.frame( date = seq(1,length(positiveIncrease_diff)), positiveIncrease_diff = positiveIncrease_diff)

aic5.wge(newcases_fl_diff$positiveIncrease_diff)


fl_arima_212 = arima(newcases_fl$positiveIncrease, order = c(2,1,1))
fl_arima_212$aic

phis = fl_arima_212$coef[1:2]
thetas = fl_arima_212$coef[3]
s = 0
d = 1

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(135-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_fl$positiveIncrease[i:(i+(trainingSize-1))],phi = phis, theta = thetas, 
                             s = 0, d = 1,n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_fl$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(2,1,1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE



```

Building an AR model on FL Cases
```{r}
aic5.wge(newcases_fl$positiveIncrease)

#Work with the less complex AR(1)

fl_ar_1 = arima(newcases_fl$positiveIncrease, order = c(1,0,0))
fl_ar_1$aic

phis = fl_ar_1$coef[1]
thetas = 0
s = 0
d = 0

trainingSize = 70
horizon = 12
ASEHolder = numeric()

for( i in 1:(135-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_fl$positiveIncrease[i:(i+(trainingSize-1))],phi = phis,  
                             s = 0, d = 0,n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_fl$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model AR(1) for Florida Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE

```

Building an ARIMA model on US Cases
```{r}
plotts.sample.wge(newcases_us$positiveIncrease)

positiveIncrease_diff = artrans.wge(newcases_us$positiveIncrease, 1)
newcases_us_diff = data.frame( date = seq(1,length(positiveIncrease_diff)), positiveIncrease_diff = positiveIncrease_diff)

#Maxing out at 5,2 lets check the BIC and expand ps
aic5.wge(newcases_us_diff$positiveIncrease_diff, p = 0:10, type = "bic")

us_arima_est = est.arma.wge(newcases_us_diff$positiveIncrease_diff, p = 6, q = 1)

us_arima_611 = arima(newcases_us$positiveIncrease, order = c(6,1,1))
us_arima_611$aic



phis = us_arima_611$coef[1:6]
thetas = us_arima_611$coef[7]

trainingSize = 70
horizon = 12
ASEHolder = numeric()


for( i in 1:(177-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_us$positiveIncrease[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 0, d = 1,n.ahead = horizon, plot = FALSE)
  
  ASE = mean((newcases_us$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARIMA(6,1,1) for US Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE


```
Stationary US Model

```{r}
aic5.wge(newcases_us$positiveIncrease)

us_arma_12 = arima(newcases_us$positiveIncrease, order = c(1,0,2))
us_arma_12$aic

est.arma.wge(newcases_us$positiveIncrease, p = 1, q = 2)


phis = 0.9919401
thetas = c(-0.18789321 -0.06864411)

trainingSize = 70
horizon = 12
ASEHolder = numeric()


for( i in 1:(135-(trainingSize + horizon) + 1))
{
  
  forecasts = fore.aruma.wge(newcases_us$positiveIncrease[i:(i+(trainingSize-1))],phi = phis, theta = thetas, s = 0, d = 1,n.ahead = horizon, plot = TRUE)
  
  ASE = mean((newcases_us$positiveIncrease[(trainingSize+i):(trainingSize+ i + (horizon) - 1)] - forecasts$f)^2)
  ASEHolder[i] = ASE
  
}

ASEHolder
#Distribution of ASEs on Two Week Periods
hist(ASEHolder, xlab = "ASE of model at a given Training Set",  main = "ASE Distribution for Model ARMA(1,2) for US Data")

#Mean ASE 
WindowedASE = mean(ASEHolder)
WindowedASE

```

Exploration of Hospitlizations. Currently Hospitalized offers a clear curve on how sever the outbreak currently is but Florida doesn't have that metric. Hospitalized Increase may be a great indicator of Covid severity but can lag behind cases in general if we assume the hospitalizaiton occurs after a positive test, important to note this is not always the case. 

```{r}
plot(x = seq(1:len_us), y = initial_data_us$hospitalizedIncrease, type = "l")

plot(x = seq(1:len_us), y = initial_data_us$hospitalizedCurrently, type = "l")


plot(x = seq(1:len_fl), y = initial_data_fl$hospitalizedIncrease, type = "l")
#Newly updated not a great # to use for fl, good for us as whole
plot(x = seq(1:len_fl), y = initial_data_fl$hospitalizedCurrently, type = "l")




```


